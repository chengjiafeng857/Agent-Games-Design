# Consistent Multi-View Character Generation

## Problem

Previously, the image generation pipeline generated front, side, and back views **independently** using separate text prompts. This caused **inconsistencies** between views:

- Different facial features
- Different clothing details
- Different proportions
- Different style interpretations

These inconsistencies made it difficult to create accurate 3D models.

## Solution

We now use a **sequential generation strategy** where:

1. **Front view** is generated first from the text prompt (reference image)
2. **Side view** is generated by editing the front view image
3. **Back view** is generated by editing the front view image

This ensures all views show the **same character** with consistent:
- Facial features and proportions
- Clothing design and colors
- Style and art direction
- Body proportions

## Implementation

### New Function: `generate_view_from_reference()`

Located in `src/stage4_image_generation.py`, this function:

```python
def generate_view_from_reference(
    spec: CharacterSpec,
    reference_image_data: bytes,
    target_view: str,
    api_key: str,
    aspect_ratio: str = IMAGE_ASPECT_RATIO,
    image_size: str = IMAGE_SIZE,
) -> GeneratedImage:
```

**Key features:**
- Takes the front view image as input (raw bytes)
- Generates a side or back view that maintains character consistency
- Uses Gemini's image editing capabilities (passing both text prompt and reference image)
- Instructs the model to "keep the exact same character design"

### Updated: `generate_tpose_images()`

The main image generation function now:

1. Generates front view first (if requested)
2. Uses front view as reference for side/back views
3. Falls back to independent generation if front view not available

**Output:**
```
Using model: gemini-3-pro-image-preview
Resolution: 2K, Aspect ratio: 1:1
Strategy: Sequential generation (front → side/back) for consistency
  Generating front view (reference)...
    ✓ front view generated
  Generating side view from front view reference...
    ✓ side view generated (based on front view)
  Generating back view from front view reference...
    ✓ back view generated (based on front view)
```

## Usage

### Standard Pipeline (with consistency)

```bash
# Generate all views consistently
uv run generate_prompts.py images -i configs/generated_config_Aya.yaml

# Full pipeline (prompts + images + 3D)
uv run generate_prompts.py all -i configs/generated_config_Aya.yaml
```

### Testing

Run the test script to verify the consistent generation:

```bash
# Dry run (no API calls)
uv run test_consistent_views.py

# Full test (with API calls - requires GEMINI_API_KEY)
export GEMINI_API_KEY='your-api-key'
uv run test_consistent_views.py
```

## Technical Details

### API Strategy

**Before (3 independent calls):**
```
API Call 1: Text prompt → Front view image
API Call 2: Text prompt → Side view image  (inconsistent)
API Call 3: Text prompt → Back view image  (inconsistent)
```

**After (1 + 2 dependent calls):**
```
API Call 1: Text prompt → Front view image
API Call 2: Text prompt + Front image → Side view image  (consistent)
API Call 3: Text prompt + Front image → Back view image  (consistent)
```

### Gemini Image Editing

We use Gemini's image editing feature by passing:
1. A text prompt describing the transformation (e.g., "Transform to side view")
2. The reference image (front view)

The model understands to:
- Keep the character's identity
- Change only the viewing angle
- Maintain all design elements

### Editing Prompt Structure

For side and back views, we build prompts like:

```
Transform this character to show a SIDE VIEW (profile) facing left.
Keep the exact same character design, clothing, colors, and proportions.
Show the character in T-pose with arms extended horizontally.
...
Maintain the character's identity as Aya, a Nimble courier
in stylized cel-shaded sci-fi style with slim, mid-thigh coat, courier harness silhouette.
Keep color scheme: teal accents, magenta accents, amber accents, neutral gray.
...
[Technical requirements for 3D rigging]
```

## Benefits

1. **Consistency**: All views show the same character
2. **Better 3D Models**: Consistent input → better 3D reconstruction
3. **Fewer Regenerations**: Less need to regenerate due to inconsistencies
4. **Faster Iteration**: Edit front view once, regenerate others if needed

## Fallback Behavior

If front view is not generated (e.g., `views=["side", "back"]`), the pipeline falls back to independent generation:

```python
if front_image is not None:
    # Use reference-based generation (consistent)
    generate_view_from_reference(...)
else:
    # Fallback to independent generation
    generate_image_with_gemini(...)
```

## Future Improvements

Potential enhancements:
1. Allow regenerating side/back views from an existing front view
2. Support custom reference views (not just front)
3. Add view consistency validation
4. Support editing multiple views at once

## See Also

- `src/stage4_image_generation.py` - Main implementation
- `test_consistent_views.py` - Test script
- `README.md` - Overall pipeline documentation

